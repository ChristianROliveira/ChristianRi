<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Controle de Gastos</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #f9f9f9;
      --card: #fff;
      --primary: #28a745;
      --danger: #dc3545;
      --text: #333;
    }
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }
    h1, h2 {
      color: var(--text);
    }
    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .tabs button {
      padding: 10px 16px;
      border: none;
      background: #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      flex: 1 1 auto;
      min-width: 100px;
    }
    .tabs button.active {
      background: var(--primary);
      color: white;
    }
    .tab-content {
      display: none;
      background: var(--card);
      padding: 20px;
      margin-top: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .tab-content.active {
      display: block;
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: 600;
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 4px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }
    input[type=number] {
      /* Evitar zoom iOS */
      inputmode: decimal;
      pattern: "[0-9]*";
    }
    .checkbox-group {
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: normal;
    }
    .btn {
      margin-top: 15px;
      padding: 12px 24px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
    }
    .summary p {
      margin: 8px 0;
    }
    canvas {
      width: 100% !important;
      max-width: 100%;
      height: auto !important;
    }
    @media (max-width: 600px) {
      .tabs {
        flex-direction: column;
      }
      .tab-content {
        padding: 15px;
        margin: 10px 0;
      }
      input, select {
        font-size: 18px;
      }
      .btn {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <h1>ðŸ’¸ Controle de Gastos</h1>
  <div class="tabs">
    <button class="tab-btn active" data-tab="resumo">ðŸ“Š Resumo</button>
    <button class="tab-btn" data-tab="transacao">âž• Nova TransaÃ§Ã£o</button>
    <button class="tab-btn" data-tab="metas">ðŸŽ¯ Metas</button>
  </div>

  <div id="resumo" class="tab-content active">
    <h2>Resumo Mensal</h2>
    <canvas id="grafico"></canvas>
    <div id="resumoDados" class="summary"></div>
  </div>

  <div id="transacao" class="tab-content">
    <h2>Adicionar TransaÃ§Ã£o</h2>
    <form id="formTransacao">
      <label for="descricao">DescriÃ§Ã£o</label>
      <input type="text" id="descricao" required />

      <label for="valor">Valor (R$)</label>
      <input type="number" id="valor" required inputmode="decimal" pattern="[0-9]*" step="0.01" />

      <label for="categoria">Categoria</label>
      <input type="text" id="categoria" required />

      <label for="mes">MÃªs</label>
      <select id="mes"></select>

      <label for="tipo">Tipo</label>
      <select id="tipo">
        <option value="entrada">Entrada</option>
        <option value="saida">SaÃ­da</option>
      </select>

      <div class="checkbox-group">
        <input type="checkbox" id="recorrente" />
        <label for="recorrente">Ã‰ recorrente (ex: salÃ¡rio)</label>
      </div>

      <label for="parcelas" id="labelParcelas">NÃºmero de Parcelas (1 se Ãºnica)</label>
      <input type="number" id="parcelas" value="1" min="1" />

      <button type="submit" class="btn">Salvar</button>
    </form>
  </div>

  <div id="metas" class="tab-content">
    <h2>Definir Meta</h2>
    <form id="formMeta">
      <label for="metaCategoria">Categoria</label>
      <input type="text" id="metaCategoria" required />

      <label for="metaValor">Valor (R$)</label>
      <input type="number" id="metaValor" required inputmode="decimal" pattern="[0-9]*" step="0.01" />

      <label for="metaMes">MÃªs</label>
      <select id="metaMes"></select>

      <button type="submit" class="btn">Salvar Meta</button>
    </form>
    <div id="listaMetas" class="summary"></div>
  </div>

  <script>
    const meses = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
    let transacoes = {};
    let metas = {};
    let recorrentes = [];
    let parcelasPendentes = [];

    const chartCtx = document.getElementById('grafico').getContext('2d');
    let chart;

    // Inicializa selects de meses
    function initSelects() {
      [document.getElementById('mes'), document.getElementById('metaMes')].forEach(select => {
        select.innerHTML = '';
        meses.forEach(m => select.appendChild(new Option(m, m)));
      });
    }

    // Carrega dados do localStorage ou inicializa
    function carregarDados() {
      transacoes = JSON.parse(localStorage.getItem('transacoes')) || {};
      metas = JSON.parse(localStorage.getItem('metas')) || {};
      recorrentes = JSON.parse(localStorage.getItem('recorrentes')) || [];
      parcelasPendentes = JSON.parse(localStorage.getItem('parcelasPendentes')) || [];
      meses.forEach(m => {
        if (!transacoes[m]) transacoes[m] = { entradas: 0, saidas: 0 };
      });
    }

    // Salva dados no localStorage
    function salvarDados() {
      try {
        localStorage.setItem('transacoes', JSON.stringify(transacoes));
        localStorage.setItem('metas', JSON.stringify(metas));
        localStorage.setItem('recorrentes', JSON.stringify(recorrentes));
        localStorage.setItem('parcelasPendentes', JSON.stringify(parcelasPendentes));
      } catch(e) {
        alert('Erro ao salvar dados: ' + e.message);
      }
    }

    // Atualiza parcelas e recorrentes no dia 1 (simulado ao abrir)
    function atualizarParcelas() {
      const hoje = new Date();
      if (hoje.getDate() !== 1) return;

      // Atualiza parcelas
      parcelasPendentes.forEach(p => {
        if (p.restantes > 0) {
          transacoes[p.mesAtual][p.tipo === 'entrada' ? 'entradas' : 'saidas'] += p.valorMensal;
          p.restantes--;
          p.mesAtual = proximoMes(p.mesAtual);
        }
      });

      // Atualiza recorrentes
      const mesAtual = meses[hoje.getMonth()];
      recorrentes.forEach(r => {
        transacoes[mesAtual][r.tipo === 'entrada' ? 'entradas' : 'saidas'] += r.valor;
      });

      salvarDados();
    }

    // Retorna o prÃ³ximo mÃªs da lista
    function proximoMes(mes) {
      const i = meses.indexOf(mes);
      return meses[(i + 1) % 12];
    }

    // Atualiza resumo e grÃ¡fico
    function atualizarResumo() {
      const resumo = document.getElementById('resumoDados');
      resumo.innerHTML = '';
      const entradas = [];
      const saidas = [];
      meses.forEach(mes => {
        const { entradas: e = 0, saidas: s = 0 } = transacoes[mes] || {};
        const saldo = e - s;
        entradas.push(e);
        saidas.push(s);
        resumo.innerHTML += `<p><strong>${mes}:</strong> Entradas: R$ ${e.toFixed(2)}, SaÃ­das: R$ ${s.toFixed(2)}, Saldo: R$ ${saldo.toFixed(2)}</p>`;
      });

      if (chart) chart.destroy();
      chart = new Chart(chartCtx, {
        type: 'bar',
        data: {
          labels: meses,
          datasets: [
            { label: 'Entradas', data: entradas, backgroundColor: '#28a745' },
            { label: 'SaÃ­das', data: saidas, backgroundColor: '#dc3545' },
          ]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // Atualiza lista de metas
    function atualizarMetas() {
      const lista = document.getElementById('listaMetas');
      lista.innerHTML = '';
      for (const mes in metas) {
        lista.innerHTML += `<strong>${mes}</strong><br>`;
        for (const cat in metas[mes]) {
          lista.innerHTML += `${cat}: R$ ${metas[mes][cat]}<br>`;
        }
      }
    }

    // Controla habilitaÃ§Ã£o do campo parcelas conforme checkbox recorrente
    document.getElementById('recorrente').addEventListener('change', e => {
      const parcelasInput = document.getElementById('parcelas');
      const labelParcelas = document.getElementById('labelParcelas');
      if (e.target.checked) {
        parcelasInput.value = 1;
        parcelasInput.disabled = true;
        labelParcelas.textContent = 'NÃºmero de Parcelas (Desabilitado para recorrente)';
      } else {
        parcelasInput.disabled = false;
        labelParcelas.textContent = 'NÃºmero de Parcelas (1 se Ãºnica)';
      }
    });

    // Troca de abas
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
        if (btn.dataset.tab === 'resumo') atualizarResumo();
      };
    });

    // Salva transaÃ§Ã£o
    document.getElementById('formTransacao').onsubmit = e => {
      e.preventDefault();
      const mes = document.getElementById('mes').value;
      const tipo = document.getElementById('tipo').value;
      const valor = parseFloat(document.getElementById('valor').value);
      const descricao = document.getElementById('descricao').value.trim();
      const categoria = document.getElementById('categoria').value.trim();
      const recorrente = document.getElementById('recorrente').checked;
      const parcelas = parseInt(document.getElementById('parcelas').value);

      if (!descricao || !categoria || isNaN(valor) || valor <= 0) {
        alert('Preencha todos os campos corretamente.');
        return;
      }

      if (recorrente) {
        recorrentes.push({ descricao, categoria, tipo, valor });
      } else {
        if (parcelas === 1) {
          transacoes[mes][tipo === 'entrada' ? 'entradas' : 'saidas'] += valor;
        } else {
          parcelasPendentes.push({
            descricao,
            categoria,
            valorMensal: +(valor / parcelas).toFixed(2),
            tipo,
            mesAtual: mes,
            restantes: parcelas
          });
        }
      }

      salvarDados();
      e.target.reset();

      // Reset campo parcelas
      document.getElementById('parcelas').disabled = false;
      document.getElementById('labelParcelas').textContent = 'NÃºmero de Parcelas (1 se Ãºnica)';
      document.getElementById('recorrente').checked = false;

      atualizarResumo();
      alert('TransaÃ§Ã£o adicionada com sucesso!');
    };

    // Salva metas
    document.getElementById('formMeta').onsubmit = e => {
      e.preventDefault();
      const mes = document.getElementById('metaMes').value;
      const categoria = document.getElementById('metaCategoria').value.trim();
      const valor = parseFloat(document.getElementById('metaValor').value);

      if (!categoria || isNaN(valor) || valor <= 0) {
        alert('Preencha todos os campos da meta corretamente.');
        return;
      }

      metas[mes] = metas[mes] || {};
      metas[mes][categoria] = valor;
      salvarDados();
      e.target.reset();
      atualizarMetas();
      alert('Meta salva com sucesso!');
    };

    // InicializaÃ§Ã£o
    initSelects();
    carregarDados();
    atualizarParcelas();
    atualizarResumo();
    atualizarMetas();
  </script>
</body>
</html>
